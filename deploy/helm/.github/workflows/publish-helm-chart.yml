name: å‘å¸ƒ Helm Chart åˆ° GitHub Pages

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Chart ç‰ˆæœ¬å·'
        required: true
        default: '1.0.0'

jobs:
  publish-helm-chart:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: å®‰è£… Helm
      uses: azure/setup-helm@v3
      with:
        version: '3.12.0'

    - name: é…ç½® Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: èŽ·å–ç‰ˆæœ¬å·
      id: get_version
      run: |
        if [ "${{ github.event_name }}" == "push" ]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        else
          VERSION=${{ github.event.inputs.version }}
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "å‘å¸ƒç‰ˆæœ¬: $VERSION"

    - name: éªŒè¯ Helm Chart
      run: |
        cd backend/deploy/helm
        helm lint .
        helm template . --debug > /dev/null
        echo "âœ… Helm Chart éªŒè¯é€šè¿‡"

    - name: æ›´æ–° Chart ç‰ˆæœ¬
      run: |
        cd backend/deploy/helm
        sed -i "s/^version:.*/version: ${{ steps.get_version.outputs.version }}/" Chart.yaml
        sed -i "s/^appVersion:.*/appVersion: ${{ steps.get_version.outputs.version }}/" Chart.yaml
        echo "ðŸ“ Chart ç‰ˆæœ¬å·²æ›´æ–°åˆ° ${{ steps.get_version.outputs.version }}"

    - name: æ‰“åŒ… Helm Chart
      run: |
        cd backend/deploy/helm
        helm package . --destination /tmp/
        echo "ðŸ“¦ Helm Chart æ‰“åŒ…å®Œæˆ"

    - name: æ£€å‡º gh-pages åˆ†æ”¯
      uses: actions/checkout@v4
      with:
        ref: gh-pages
        path: gh-pages
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: è®¾ç½® gh-pages åˆ†æ”¯
      run: |
        if [ ! -d "gh-pages" ]; then
          mkdir gh-pages
          cd gh-pages
          git init
          git remote add origin https://github.com/${{ github.repository }}.git
          git checkout -b gh-pages
        fi

    - name: å¤åˆ¶ Chart åŒ…å¹¶æ›´æ–°ç´¢å¼•
      run: |
        cd gh-pages
        cp /tmp/mcp-box-${{ steps.get_version.outputs.version }}.tgz ./
        
        # ç”Ÿæˆæˆ–æ›´æ–° index.yaml
        if [ -f index.yaml ]; then
          helm repo index . --merge index.yaml --url "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        else
          helm repo index . --url "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        fi

    - name: åˆ›å»º README
      run: |
        cd gh-pages
        cat > README.md << EOF
        # MCP-Box Helm Charts

        è¿™æ˜¯ MCP-Box é¡¹ç›®çš„å®˜æ–¹ Helm Charts ä»“åº“ã€‚

        ## å¿«é€Ÿå¼€å§‹

        ### æ·»åŠ  Helm ä»“åº“

        \`\`\`bash
        helm repo add mcp-box https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
        helm repo update
        \`\`\`

        ### å®‰è£… MCP-Box

        \`\`\`bash
        # ä½¿ç”¨é»˜è®¤é…ç½®å®‰è£…
        helm install mcp-box mcp-box/mcp-box

        # ä½¿ç”¨è‡ªå®šä¹‰é…ç½®å®‰è£…
        helm install mcp-box mcp-box/mcp-box -f values-custom.yaml

        # æŒ‡å®šå‘½åç©ºé—´å®‰è£…
        helm install mcp-box mcp-box/mcp-box -n mcp-system --create-namespace
        \`\`\`

        ### å‡çº§ MCP-Box

        \`\`\`bash
        helm upgrade mcp-box mcp-box/mcp-box
        \`\`\`

        ### å¸è½½ MCP-Box

        \`\`\`bash
        helm uninstall mcp-box
        \`\`\`

        ## é…ç½®è¯´æ˜Ž

        ### åŸºæœ¬é…ç½®

        \`\`\`yaml
        global:
          domain: "your-domain.com"
          version: "${{ steps.get_version.outputs.version }}"
          registry: "your-registry.com"

        services:
          web:
            enabled: true
            replicas: 2
          market:
            enabled: true
            replicas: 1
          authz:
            enabled: true
            replicas: 1
        \`\`\`

        ### æŒä¹…åŒ–å­˜å‚¨

        \`\`\`yaml
        infrastructure:
          mysql:
            persistence:
              enabled: true
              size: 100Gi
              storageClass: "fast-ssd"
          redis:
            persistence:
              enabled: true
              size: 50Gi
        \`\`\`

        ## ç‰ˆæœ¬ä¿¡æ¯

        - å½“å‰ç‰ˆæœ¬: ${{ steps.get_version.outputs.version }}
        - å‘å¸ƒæ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        - æž„å»ºå·: ${{ github.run_number }}

        ## æ”¯æŒä¸Žåé¦ˆ

        - ðŸ› [æŠ¥å‘Šé—®é¢˜](https://github.com/${{ github.repository }}/issues)
        - ðŸ“– [æŸ¥çœ‹æ–‡æ¡£](https://github.com/${{ github.repository }}/blob/main/README.md)
        - ðŸ’¬ [è®¨è®ºäº¤æµ](https://github.com/${{ github.repository }}/discussions)

        ## è®¸å¯è¯

        æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ï¼Œè¯¦æƒ…è¯·æŸ¥çœ‹ [LICENSE](https://github.com/${{ github.repository }}/blob/main/LICENSE) æ–‡ä»¶ã€‚
        EOF

    - name: æäº¤å¹¶æŽ¨é€åˆ° gh-pages
      run: |
        cd gh-pages
        git add .
        git commit -m "å‘å¸ƒ mcp-box v${{ steps.get_version.outputs.version }}" || exit 0
        git push origin gh-pages

    - name: è¾“å‡ºå‘å¸ƒä¿¡æ¯
      run: |
        echo "ðŸŽ‰ Helm Chart å‘å¸ƒæˆåŠŸ!"
        echo "ðŸ“¦ ç‰ˆæœ¬: ${{ steps.get_version.outputs.version }}"
        echo "ðŸŒ ä»“åº“åœ°å€: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        echo ""
        echo "ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ·»åŠ ä»“åº“:"
        echo "helm repo add mcp-box https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        echo "helm repo update"
        echo "helm install mcp-box mcp-box/mcp-box"