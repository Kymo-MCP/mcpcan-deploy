name: Release Helm Chart

on:
  push:
    branches:
      - 'main'
      - 'v1.0.0-dev'
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Chart ç‰ˆæœ¬å·'
        required: true
        default: '1.0.0'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: é…ç½® Git
      run: |
        git config user.name "$GITHUB_ACTOR"
        git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

    - name: å®‰è£… Helm
      uses: azure/setup-helm@v3
      with:
        version: '3.12.0'

    - name: è·å–ç‰ˆæœ¬å·
      id: get_version
      run: |
        if [ "${{ github.event_name }}" == "push" ]; then
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # æ ‡ç­¾æ¨é€ï¼Œæå–ç‰ˆæœ¬å·
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            # åˆ†æ”¯æ¨é€ï¼Œä» VERSION æ–‡ä»¶è¯»å–æˆ–ç”Ÿæˆå¼€å‘ç‰ˆæœ¬
            if [ -f VERSION ]; then
              VERSION=$(cat VERSION)
            else
              VERSION="dev-$(date +%Y%m%d-%H%M%S)"
            fi
          fi
        else
          # æ‰‹åŠ¨è§¦å‘
          VERSION=${{ github.event.inputs.version }}
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "å‘å¸ƒç‰ˆæœ¬: $VERSION"

    - name: éªŒè¯ Helm Chart
      run: |
        cd helm
        helm lint .
        helm template . --debug > /dev/null
        echo "âœ… Helm Chart éªŒè¯é€šè¿‡"

    - name: æ›´æ–° Chart ç‰ˆæœ¬
      run: |
        cd helm
        sed -i "s/^version:.*/version: ${{ steps.get_version.outputs.version }}/" Chart.yaml
        sed -i "s/^appVersion:.*/appVersion: ${{ steps.get_version.outputs.version }}/" Chart.yaml
        echo "ğŸ“ Chart ç‰ˆæœ¬å·²æ›´æ–°åˆ° ${{ steps.get_version.outputs.version }}"

    - name: è¿è¡Œ chart-releaser
      uses: helm/chart-releaser-action@v1.6.0
      with:
        charts_dir: .
        config: cr.yaml
      env:
        CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

    - name: è¾“å‡ºå‘å¸ƒä¿¡æ¯
      run: |
        echo "ğŸ‰ Helm Chart å‘å¸ƒæˆåŠŸ!"
        echo "ğŸ“¦ ç‰ˆæœ¬: ${{ steps.get_version.outputs.version }}"
        echo "ğŸŒ ä»“åº“åœ°å€: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        echo "ğŸ“‹ Releases: https://github.com/${{ github.repository }}/releases"
        echo ""
        echo "ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ·»åŠ ä»“åº“:"
        echo "helm repo add mcp-box https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        echo "helm repo update"
        echo "helm install mcp-box mcp-box/mcp-box"