name: Release

# 触发条件：推送到主分支
on:
  push:
    branches: 
      - main
      - feature/v1.7.0-dev

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 授予创建Release/Tag的权限
      pull-requests: read
    
    # 定义输出，供后续任务使用
    outputs:
      tag: ${{ steps.version.outputs.tag }}

    steps:
      # 步骤1：检出代码
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 拉取完整提交历史，用于生成Release Notes

      # 步骤2：读取VERSION文件
      - name: Read VERSION file
        id: version
        run: |
          if [ -f "VERSION" ]; then
            VERSION=$(cat VERSION | tr -d '\n\r' | xargs)
            echo "Read version from file: $VERSION"
            echo "tag=$VERSION" >> $GITHUB_OUTPUT
          else
            echo "❌ VERSION file not found"
            exit 1
          fi

      # 步骤3：创建GitHub Release并推送Tag
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}  # 使用VERSION文件中的版本
          name: Release ${{ steps.version.outputs.tag }}  # Release标题
          generate_release_notes: true  # 让GitHub自动生成Release Notes
          draft: false  # 不创建草稿，直接发布
          prerelease: false  # 非预发布版本
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 在发布完成后触发Pages部署
  deploy-pages:
    needs: release
    uses: ./.github/workflows/gh-pages.yml
    permissions:
      contents: read
      pages: write
      id-token: write
      actions: read
