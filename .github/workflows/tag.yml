name: Release Tag

# è§¦å‘å™¨é…ç½®
on:
  push:                 # è‡ªåŠ¨è§¦å‘
    branches:
      - 'v[0-9]+\.[0-9]+\.[0-9]+'  # åªç›‘å¬ v*.*.* æ ¼å¼çš„åˆ†æ”¯
  workflow_dispatch:       # æ‰‹åŠ¨è§¦å‘
    inputs:
      ReleaseTag:
        description: 'æ˜¯å¦åˆ›å»ºå‘å¸ƒæ ‡ç­¾'
        required: true
        type: boolean
        default: false
    

permissions:
  contents: write

jobs:
  create-tag:
    runs-on: ubuntu-latest
    # æ‰‹åŠ¨è§¦å‘æ—¶éœ€è¦ ReleaseTag ä¸º trueï¼Œè‡ªåŠ¨è§¦å‘æ—¶ç›´æ¥æ‰§è¡Œ
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.ReleaseTag == 'true')
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è·å–åˆ†æ”¯ä¿¡æ¯
        id: branch_info
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          echo "å½“å‰åˆ†æ”¯: $BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: éªŒè¯åˆ†æ”¯æ ¼å¼
        id: validate_branch
        run: |
          BRANCH_NAME="${{ steps.branch_info.outputs.branch_name }}"
          # æ£€æŸ¥åˆ†æ”¯åç§°æ˜¯å¦ç¬¦åˆ v*.*.* æ ¼å¼ï¼ˆå¦‚ v1.0.1, v2.3.1ï¼‰
          # ä¸å…è®¸æœ‰å…¶ä»–åç¼€ï¼ˆå¦‚ v1.0.1-devï¼‰
          if [[ $BRANCH_NAME =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âœ… åˆ†æ”¯æ ¼å¼éªŒè¯é€šè¿‡: $BRANCH_NAME"
            echo "valid_branch=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ åˆ†æ”¯æ ¼å¼ä¸ç¬¦åˆè¦æ±‚: $BRANCH_NAME"
            echo "âŒ è¦æ±‚æ ¼å¼: v*.*.* (å¦‚ v1.0.1, v2.3.1)"
            echo "âŒ ä¸å…è®¸åç¼€: v1.0.1-dev, v1.0.1-alpha ç­‰"
            echo "valid_branch=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: ç”Ÿæˆæ ‡ç­¾åç§°
        id: tag_info
        run: |
          BRANCH_NAME="${{ steps.branch_info.outputs.branch_name }}"
          # ä½¿ç”¨åˆ†æ”¯åç§°ä½œä¸ºæ ‡ç­¾åç§°
          TAG_NAME="$BRANCH_NAME"
          echo "æ ‡ç­¾åç§°: $TAG_NAME"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å­˜åœ¨
        id: check_tag
        # åªæœ‰åœ¨åˆ†æ”¯æ ¼å¼éªŒè¯é€šè¿‡åæ‰æ‰§è¡Œ
        if: steps.validate_branch.outputs.valid_branch == 'true'
        run: |
          TAG_NAME="${{ steps.tag_info.outputs.tag_name }}"
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG_NAME$"; then
            echo "æ ‡ç­¾ $TAG_NAME å·²å­˜åœ¨"
            echo "tag_exists=true" >> $GITHUB_OUTPUT
          else
            echo "æ ‡ç­¾ $TAG_NAME ä¸å­˜åœ¨ï¼Œå¯ä»¥åˆ›å»º"
            echo "tag_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: åˆ›å»ºå¹¶æ¨é€æ ‡ç­¾
        if: steps.validate_branch.outputs.valid_branch == 'true' && steps.check_tag.outputs.tag_exists == 'false'
        run: |
          TAG_NAME="${{ steps.tag_info.outputs.tag_name }}"
          BRANCH_NAME="${{ steps.branch_info.outputs.branch_name }}"
          
          # é…ç½® Git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # åˆ›å»ºæ ‡ç­¾
          git tag -a "$TAG_NAME" -m "ä»åˆ†æ”¯ $BRANCH_NAME åˆ›å»ºå‘å¸ƒæ ‡ç­¾ $TAG_NAME"
          
          # æ¨é€æ ‡ç­¾
          git push origin "$TAG_NAME"
          
          echo "âœ… æˆåŠŸåˆ›å»ºå¹¶æ¨é€æ ‡ç­¾: $TAG_NAME"
          echo "ğŸ“ æ¥æºåˆ†æ”¯: $BRANCH_NAME"

      - name: è·³è¿‡åˆ›å»ºï¼ˆæ ‡ç­¾å·²å­˜åœ¨ï¼‰
        if: steps.validate_branch.outputs.valid_branch == 'true' && steps.check_tag.outputs.tag_exists == 'true'
        run: |
          TAG_NAME="${{ steps.tag_info.outputs.tag_name }}"
          echo "â­ï¸ è·³è¿‡æ ‡ç­¾åˆ›å»º"
          echo "ğŸ·ï¸ æ ‡ç­¾ $TAG_NAME å·²å­˜åœ¨"