name: Release Tag

# è§¦å‘å™¨é…ç½®
on:
  push:                 # è‡ªåŠ¨è§¦å‘
    branches:
      - main            # ç›‘å¬ main åˆ†æ”¯å˜åŠ¨
      - feature/v1.7.0-dev  # Added for testing

  workflow_dispatch:    # æ‰‹åŠ¨è§¦å‘
    inputs:
      ReleaseTag:
        description: 'æ˜¯å¦åˆ›å»ºå‘å¸ƒæ ‡ç­¾'
        required: true
        type: boolean
        default: false
    

permissions:
  contents: write

jobs:
  create-tag:
    runs-on: ubuntu-latest
    # æ‰‹åŠ¨è§¦å‘æ—¶éœ€è¦ ReleaseTag ä¸º trueï¼Œè‡ªåŠ¨è§¦å‘æ—¶ç›´æ¥æ‰§è¡Œ
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.ReleaseTag == 'true')
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è¯»å–VERSIONæ–‡ä»¶
        id: version_info
        run: |
          if [ -f "VERSION" ]; then
            VERSION=$(cat VERSION | tr -d '\n\r' | xargs)
            echo "ä»VERSIONæ–‡ä»¶è¯»å–ç‰ˆæœ¬: $VERSION"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          else
            echo "âŒ VERSIONæ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi

      - name: éªŒè¯ç‰ˆæœ¬æ ¼å¼
        id: validate_version
        run: |
          VERSION="${{ steps.version_info.outputs.version }}"
          # æ£€æŸ¥ç‰ˆæœ¬å·æ˜¯å¦ç¬¦åˆ v*.*.* æ ¼å¼ï¼ˆå¦‚ v1.0.1, v2.3.1ï¼‰
          # ä¸å…è®¸æœ‰å…¶ä»–åç¼€ï¼ˆå¦‚ v1.0.1-devï¼‰
          if [[ $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âœ… ç‰ˆæœ¬æ ¼å¼éªŒè¯é€šè¿‡: $VERSION"
            echo "valid_version=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ ç‰ˆæœ¬æ ¼å¼ä¸ç¬¦åˆè¦æ±‚: $VERSION"
            echo "âŒ è¦æ±‚æ ¼å¼: v*.*.* (å¦‚ v1.0.1, v2.3.1)"
            echo "âŒ ä¸å…è®¸åç¼€: v1.0.1-dev, v1.0.1-alpha ç­‰"
            echo "valid_version=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: ç”Ÿæˆæ ‡ç­¾åç§°
        id: tag_info
        run: |
          VERSION="${{ steps.version_info.outputs.version }}"
          # ä½¿ç”¨VERSIONæ–‡ä»¶ä¸­çš„ç‰ˆæœ¬å·ä½œä¸ºæ ‡ç­¾åç§°
          TAG_NAME="$VERSION"
          echo "æ ‡ç­¾åç§°: $TAG_NAME"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å­˜åœ¨
        id: check_tag
        # åªæœ‰åœ¨ç‰ˆæœ¬æ ¼å¼éªŒè¯é€šè¿‡åæ‰æ‰§è¡Œ
        if: steps.validate_version.outputs.valid_version == 'true'
        run: |
          TAG_NAME="${{ steps.tag_info.outputs.tag_name }}"
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG_NAME$"; then
            echo "æ ‡ç­¾ $TAG_NAME å·²å­˜åœ¨"
            echo "tag_exists=true" >> $GITHUB_OUTPUT
          else
            echo "æ ‡ç­¾ $TAG_NAME ä¸å­˜åœ¨ï¼Œå¯ä»¥åˆ›å»º"
            echo "tag_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: åˆ›å»ºå¹¶æ¨é€æ ‡ç­¾
        if: steps.validate_version.outputs.valid_version == 'true' && steps.check_tag.outputs.tag_exists == 'false'
        run: |
          TAG_NAME="${{ steps.tag_info.outputs.tag_name }}"
          VERSION="${{ steps.version_info.outputs.version }}"
          
          # é…ç½® Git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # åˆ›å»ºæ ‡ç­¾
          git tag -a "$TAG_NAME" -m "ä»mainåˆ†æ”¯åˆ›å»ºå‘å¸ƒæ ‡ç­¾ $TAG_NAME (ç‰ˆæœ¬: $VERSION)"
          
          # ä½¿ç”¨å®Œæ•´å¼•ç”¨è·¯å¾„æ¨é€æ ‡ç­¾ï¼Œé¿å…ä¸åŒååˆ†æ”¯å†²çª
          git push origin "refs/tags/$TAG_NAME"
          
          echo "âœ… æˆåŠŸåˆ›å»ºå¹¶æ¨é€æ ‡ç­¾: $TAG_NAME"
          echo "ğŸ“ æ¥æºåˆ†æ”¯: main"
          echo "ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯: $VERSION"

      - name: å¼ºåˆ¶æ›´æ–°æ ‡ç­¾ï¼ˆå¦‚æœå·²å­˜åœ¨ï¼‰
        if: steps.validate_version.outputs.valid_version == 'true' && steps.check_tag.outputs.tag_exists == 'true'
        run: |
          TAG_NAME="${{ steps.tag_info.outputs.tag_name }}"
          VERSION="${{ steps.version_info.outputs.version }}"
          
          # é…ç½® Git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # åˆ é™¤è¿œç¨‹æ ‡ç­¾
          git push origin --delete "refs/tags/$TAG_NAME" || true
          
          # åˆ é™¤æœ¬åœ°æ ‡ç­¾ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          git tag -d "$TAG_NAME" || true
          
          # åˆ›å»ºæ–°æ ‡ç­¾
          git tag -a "$TAG_NAME" -m "ä»mainåˆ†æ”¯å¼ºåˆ¶æ›´æ–°å‘å¸ƒæ ‡ç­¾ $TAG_NAME (ç‰ˆæœ¬: $VERSION)"
          
          # æ¨é€æ–°æ ‡ç­¾
          git push origin "refs/tags/$TAG_NAME"
          
          echo "âœ… æˆåŠŸå¼ºåˆ¶æ›´æ–°æ ‡ç­¾: $TAG_NAME"
          echo "ğŸ“ æ¥æºåˆ†æ”¯: main"
          echo "ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯: $VERSION"
          echo "âš ï¸ æ³¨æ„: å·²å¼ºåˆ¶è¦†ç›–ç°æœ‰æ ‡ç­¾"