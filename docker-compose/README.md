# MCPCan Docker Compose Deployment Guide

This document provides detailed instructions for deploying the MCPCan system using Docker Compose. This deployment scheme supports dual HTTP/HTTPS access and is suitable for local development, testing, or lightweight production environments.

## Table of Contents

1. [Prerequisites](#prerequisites)
2. [Quick Start](#quick-start)
   - [Default Quick Start](#21-default-quick-start)
   - [Custom Configuration Start](#22-custom-configuration-start)
3. [Accessing Services](#accessing-services)
4. [Advanced Configuration](#advanced-configuration)
   - [Certificate Replacement & Hot Reloading](#41-certificate-replacement--hot-reloading)
   - [Custom Configuration](#42-custom-configuration)
5. [Service Architecture](#service-architecture)
6. [Data Persistence](#data-persistence)
7. [FAQ](#faq)

## Prerequisites

- **Docker Engine**: 20.10.0+
- **Docker Compose**: v2.0.0+ (Docker Compose V2 recommended)

## Quick Start

Enter the deployment directory:
```bash
cd docker-compose/
```

### 2.1 Default Quick Start

If you do not need to modify any ports or configurations, simply run the following command to start (default ports 80 and 443):

```bash
docker compose up -d
```

- **HTTP Access**: [http://localhost](http://localhost) (Default port 80)
- **HTTPS Access**: [https://localhost](https://localhost) (Default port 443)
This command will start all services using the default configuration preset in the repository.

### 2.2 Custom Configuration Start

If you need to modify database passwords, ports, domain names, or image versions, please follow these steps:

1. **Create Configuration File**:
   Copy the example environment file:
   ```bash
   cp example.env .env
   ```
   Use an editor to modify variables in `.env` (e.g., `MYSQL_PASSWORD`, `HOST_HTTP_PORT`, etc.).

2. **Generate Configuration and Start**:
   Run the replacement script. This script generates new service configuration files based on `.env` (old configurations will be automatically backed up) and then forces container recreation:
   ```bash
   ./replace.sh && docker compose up -d --force-recreate
   ```

   **Startup Process**:
   1. The script generates new yaml configuration files into the `config/` directory based on templates and `.env`.
   2. Starts MySQL and Redis, waiting for health checks to pass.
   3. Runs `mcp-init` for initialization (database migration/seed data).
   4. Starts backend services (`mcp-authz`, `mcp-market`, `mcp-gateway`).
   5. Starts the gateway proxy (`traefik`) and frontend service (`mcp-web`).

## Accessing Services

The system enables both HTTP and HTTPS access by default, without interference (no forced redirection).

- **HTTP Access**: [http://localhost](http://localhost) (Default port 80)
- **HTTPS Access**: [https://localhost](https://localhost) (Default port 443)
  - *Note: By default, a self-signed certificate is used. Browsers may warn about insecurity; please click "Proceed" or "Advanced -> Proceed".*

| Service | URL (HTTP) | URL (HTTPS) |
|---------|------------|-------------|
| **Web Frontend** | http://localhost | https://localhost |
| **API Gateway** | http://localhost/mcp-gateway | https://localhost/mcp-gateway |

*(Ports depend on `MCP_ENTRY_SERVICE_PORT` and `MCP_ENTRY_SERVICE_HTTPS_PORT` in `.env`)*

## Advanced Configuration

### 4.1 Certificate Replacement & Hot Reloading

MCPCan uses Traefik as the ingress gateway, supporting dynamic hot reloading of TLS certificates without restarting services.

1. **Prepare Certificates**:
   Prepare your domain certificate files (e.g., `my-domain.crt` and `my-domain.key`).

2. **Replace Files**:
   Place the certificate files into the `certs/` directory (or your mounted directory).

3. **Modify Configuration**:
   Edit the `config/dynamic.yaml` file and update the paths in the `tls` section:
   ```yaml
   tls:
     certificates:
       - certFile: /etc/traefik/certs/my-domain.crt
         keyFile: /etc/traefik/certs/my-domain.key
   ```
   *Note: The paths here are container paths. By default, the host's `./certs` maps to `/etc/traefik/certs` in the container.*

4. **Automatic Effect**:
   After saving `dynamic.yaml`, Traefik will automatically detect the file change and load the new certificates without any restart operation.

### 4.2 Custom Configuration

To simulate Kubernetes ConfigMaps, we generated configuration files for each service in the `config/` directory.

- **Template Files**: Located in `config-template/`, containing variable placeholders.
- **Generated Files**: Located in `config/`, generated by `./replace.sh`.
- **Note**: If you modify `.env`, you **MUST** re-run `./replace.sh` to apply changes to the actual configuration files in `config/`.

## Service Architecture

| Service Name | Description | Dependencies | Default Port |
|---------|------|------|---------|
| **traefik** | Ingress Gateway | - | 80, 443, 8080 |
| **mysql** | Data Storage | - | 31306 -> 3306 |
| **redis** | Cache & Message Queue | - | 31379 -> 6379 |
| **mcp-init** | Initialization Task (Runs once) | mysql, redis | - |
| **mcp-authz** | Auth & Authorization Service | mysql, redis, mcp-init | 8081 |
| **mcp-market** | Plugin/Code Market Service | mysql, redis, mcp-init, mcp-authz | 8080 |
| **mcp-gateway** | API Gateway | mysql, redis, mcp-market, mcp-authz | 8082 |
| **mcp-web** | Frontend UI | mcp-gateway | 3000 |

## Data Persistence

Data is stored by default in the `data/` directory under the current directory (controlled by `HOST_DATA_PATH` in `.env`):

- `data/mysql`: MySQL database files
- `data/redis`: Redis data files
- `data/mcpcan`: Application uploaded files, code packages, etc.

**Clean Data** (Use with Caution):
To completely reset the environment, stop containers and delete the data directory:
```bash
docker compose down
rm -rf ./data
```

## FAQ

**Q: Browser reports invalid certificate when accessing HTTPS?**
A: This is normal because a self-signed certificate is used by default. You can replace it with your own valid certificate following section [4.1 Certificate Replacement & Hot Reloading](#41-certificate-replacement--hot-reloading).

**Q: Changes to files in config/ are overwritten after restart?**
A: If you ran `./replace.sh`, it regenerates configuration files based on templates. To permanently modify configuration, please modify the template files in `config-template/`, or modify files in `config/` directly without running `replace.sh` again.

**Q: Container startup fails with "Connection refused"?**
A: Check `docker compose logs mcp-init` or other service logs. Usually, it's because the database is not yet ready. Docker Compose has `healthcheck` configured, but if the machine performance is slow, you may need to increase the timeout.
