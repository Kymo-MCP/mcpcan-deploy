
services:
  mysql:
    image: ${REGISTRY_PREFIX}/mysql:8.0.30
    container_name: mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - ${HOST_MYSQL_PATH}:/var/lib/mysql
      - ./config/mysql.conf:/etc/mysql/conf.d/mysql.conf:ro
      - ./config/mysql.init.sql:/docker-entrypoint-initdb.d/mysql.init.sql:ro
    ports:
      - "${MYSQL_PUBLIC_PORT}:${MYSQL_PORT}"
    networks:
      - mcpcan-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: ${REGISTRY_PREFIX}/redis:6-alpine
    container_name: redis
    restart: always
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - ${HOST_REDIS_PATH}:/data
    ports:
      - "${REDIS_PUBLIC_PORT}:${REDIS_PORT}"
    networks:
      - mcpcan-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  mcp-entry:
    image: ${REGISTRY_PREFIX}/mcp-entry:v3.5
    container_name: ${MCP_ENTRY_SERVICE_NAME}
    environment:
      - REGISTORY_IMAGE_MIRROR=${REGISTRY_PREFIX}
    ports:
      - "${MCP_ENTRY_SERVICE_PORT}:${MCP_ENTRY_SERVICE_PORT}"
      - "${MCP_ENTRY_SERVICE_HTTPS_PORT}:${MCP_ENTRY_SERVICE_HTTPS_PORT}"
    volumes:
      - ./config/traefik.yaml:/etc/traefik/traefik.yaml
      - ./config/dynamic.yaml:/etc/traefik/dynamic.yaml
      - ./config/certs:/etc/traefik/certs
    restart: always
    networks:
      - mcpcan-network
    command: >
      traefik
    depends_on:
      mcp-market:
        condition: service_started
      mcp-authz:
        condition: service_started
      mcp-web:
        condition: service_started

  mcp-init:
    image: ${REGISTRY_PREFIX}/mcp-init:${VERSION}
    container_name: ${MCP_INIT_SERVICE_NAME}
    volumes:
      - ./config/init.yaml:/app/config/init.yaml
      - ${HOST_DATA_PATH}:/data/mcpcan
    networks:
      - mcpcan-network
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy

  mcp-authz:
    image: ${REGISTRY_PREFIX}/mcp-authz:${VERSION}
    container_name: ${MCP_AUTHZ_SERVICE_NAME}
    restart: always
    volumes:
      - ./config/authz.yaml:/app/config/authz.yaml
      - ${HOST_DATA_PATH}:/data/mcpcan
    networks:
      - mcpcan-network
    expose:
      - "${MCP_AUTHZ_SERVICE_PORT}"
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy

  mcp-market:
    image: ${REGISTRY_PREFIX}/mcp-market:${VERSION}
    container_name: ${MCP_MARKET_SERVICE_NAME}
    restart: always
    volumes:
      - ./config/market.yaml:/app/config/market.yaml
      - ${HOST_DATA_PATH}:/data/mcpcan
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - mcpcan-network
    expose:
      - "${MCP_MARKET_SERVICE_PORT}"
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      mcp-init:
        condition: service_completed_successfully

  mcp-gateway:
    image: ${REGISTRY_PREFIX}/mcp-gateway:${VERSION}
    container_name: ${MCP_GATEWAY_SERVICE_NAME}
    restart: always
    volumes:
      - ./config/gateway.yaml:/app/config/gateway.yaml
    networks:
      - mcpcan-network
    expose:
      - "${MCP_GATEWAY_SERVICE_PORT}"
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy

  mcp-web:
    image: ${REGISTRY_PREFIX}/mcp-web:${VERSION}
    container_name: ${MCP_WEB_SERVICE_NAME}
    restart: always
    environment:
      - TZ=Asia/Shanghai
    volumes:
      - ./config/env.js:/app/env.js
      - ${HOST_DATA_PATH}/static:/app/static
    networks:
      - mcpcan-network
    expose:
      - "${MCP_WEB_SERVICE_PORT}"
    depends_on:
      mcp-authz:
        condition: service_started
      mcp-market:
        condition: service_started
      
networks:
  mcpcan-network:
    driver: bridge
