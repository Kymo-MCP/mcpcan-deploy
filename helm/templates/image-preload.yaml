{{- if .Values.global.images }}
apiVersion: batch/v1
kind: Job
metadata:
  name: mcp-image-preload-{{ .Release.Revision }}
  namespace: {{ .Release.Namespace }}
  labels:
    app: mcp-image-preload
    app.kubernetes.io/name: mcp-image-preload
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/component: preload
    app.kubernetes.io/version: {{ .Values.global.version }}
    {{- include "mcpcan.labels" . | nindent 4 }}
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-1000"
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: 864000
  template:
    metadata:
      labels:
        app: mcp-image-preload
        {{- include "mcpcan.selectorLabels" . | nindent 8 }}
      annotations:
        mcpcan.io/version: {{ .Values.global.version }}
        mcpcan.io/revision: "{{ .Release.Revision }}"
    spec:
      restartPolicy: OnFailure
      initContainers:
      {{- range $name, $img := .Values.global.images }}
      - name: preload-{{ lower $name }}
        image: {{ if $.Values.global.cn }}{{ $.Values.global.registryForMirrorCN }}{{ else }}{{ $.Values.global.registry }}{{ end }}/{{ $img }}
        imagePullPolicy: {{ $.Values.global.imagePullPolicy }}
        command:
        - /bin/sh
        - -c
        - echo preload {{ if $.Values.global.cn }}{{ $.Values.global.registryForMirrorCN }}{{ else }}{{ $.Values.global.registry }}{{ end }}/{{ $img }}
      {{- end }}
      containers:
      - name: exec
        image: {{ if .Values.global.cn }}{{ .Values.global.registryForMirrorCN }}{{ else }}{{ .Values.global.registry }}{{ end }}/{{ .Values.global.images.buybox }}
        imagePullPolicy: {{ .Values.global.imagePullPolicy }}
        command:
        - sh
        - -c
        - echo done
{{- end }}
